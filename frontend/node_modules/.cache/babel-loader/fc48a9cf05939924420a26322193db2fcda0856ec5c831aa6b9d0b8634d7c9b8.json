{"ast":null,"code":"// src/firebaseMessaging.js\nimport{getMessaging,getToken,onMessage,deleteToken}from\"firebase/messaging\";import{doc,setDoc,deleteDoc}from\"firebase/firestore\";import{auth,db,messaging}from\"./components/firebase\";// your existing modular firebase.js\nimport{onAuthStateChanged}from\"firebase/auth\";const VAPID_KEY=\"BIO2Mc6NhNj7m9xAN8OctwR5lWFytEx-1cnnjpqTTWHeJBPbwg0Qo4LbbVrEmmkfjju5835EtZD03Mgmo7K1dmc\";// paste the VAPID public key\nlet messagingInstance=null;export function initMessaging(){if(typeof window===\"undefined\"||!(\"serviceWorker\"in navigator))return;try{messagingInstance=getMessaging();}catch(e){console.warn(\"FCM init failed\",e);}}// Call this after user logs in (or once app starts if user already logged in)\nexport async function registerTokenForUser(uid){if(!uid)return null;if(!messagingInstance)initMessaging();if(!messagingInstance)return null;try{// Ensure the service worker is registered\nconst swReg=await navigator.serviceWorker.register(\"/firebase-messaging-sw.js\");// Ask permission\nconst permission=await Notification.requestPermission();if(permission!==\"granted\"){console.warn(\"Notification permission not granted\");return null;}// Get FCM token\nconst token=await getToken(messagingInstance,{vapidKey:VAPID_KEY,serviceWorkerRegistration:swReg});if(!token){console.warn(\"No FCM token returned\");return null;}// Save token to Firestore: either UserTokens/<uid> or update Donors/<uid>.fcmToken\nawait setDoc(doc(db,\"UserTokens\",uid),{token,updatedAt:new Date().toISOString()});// Optional: also update Donors collection if that user is a donor record\nawait setDoc(doc(db,\"Donors\",uid),{fcmToken:token},{merge:true});console.log(\"FCM token saved for user\",uid);return token;}catch(err){console.error(\"registerTokenForUser error\",err);return null;}}export async function removeTokenForUser(uid){try{await deleteDoc(doc(db,\"UserTokens\",uid));}catch(_){}try{await deleteToken(messaging);}catch(_){}}// Optional: in-app foreground callback\nexport function subscribeOnMessage(cb){if(!messagingInstance)initMessaging();if(!messagingInstance)return;onMessage(messagingInstance,payload=>{if(typeof cb===\"function\")cb(payload);});}// Auto-register token when user signs in; remove on sign out.\n// Add this call once in your App entry (see next step)\nexport function setupAutoRegistration(){onAuthStateChanged(auth,async user=>{if(user){// register token for signed-in user\nawait registerTokenForUser(user.uid);}else{// logged out: delete token from DB\n// If you stored uid earlier, remove it. Here we can't access previous uid; ensure you remove on logout flow.\n}});}","map":{"version":3,"names":["getMessaging","getToken","onMessage","deleteToken","doc","setDoc","deleteDoc","auth","db","messaging","onAuthStateChanged","VAPID_KEY","messagingInstance","initMessaging","window","navigator","e","console","warn","registerTokenForUser","uid","swReg","serviceWorker","register","permission","Notification","requestPermission","token","vapidKey","serviceWorkerRegistration","updatedAt","Date","toISOString","fcmToken","merge","log","err","error","removeTokenForUser","_","subscribeOnMessage","cb","payload","setupAutoRegistration","user"],"sources":["C:/Users/rajya/Desktop/Coding/WebDev/Programs/mini_project_LifeLink/blood-donor-finder/frontend/src/firebaseMessaging.js"],"sourcesContent":["// src/firebaseMessaging.js\r\nimport { getMessaging, getToken, onMessage, deleteToken } from \"firebase/messaging\";\r\nimport { doc, setDoc, deleteDoc } from \"firebase/firestore\";\r\nimport { auth, db, messaging } from \"./components/firebase\"; // your existing modular firebase.js\r\nimport { onAuthStateChanged } from \"firebase/auth\";\r\n\r\nconst VAPID_KEY = \"BIO2Mc6NhNj7m9xAN8OctwR5lWFytEx-1cnnjpqTTWHeJBPbwg0Qo4LbbVrEmmkfjju5835EtZD03Mgmo7K1dmc\"; // paste the VAPID public key\r\n\r\nlet messagingInstance = null;\r\n\r\nexport function initMessaging() {\r\n  if (typeof window === \"undefined\" || !(\"serviceWorker\" in navigator)) return;\r\n  try {\r\n    messagingInstance = getMessaging();\r\n  } catch (e) {\r\n    console.warn(\"FCM init failed\", e);\r\n  }\r\n}\r\n\r\n// Call this after user logs in (or once app starts if user already logged in)\r\nexport async function registerTokenForUser(uid) {\r\n  if (!uid) return null;\r\n  if (!messagingInstance) initMessaging();\r\n  if (!messagingInstance) return null;\r\n\r\n  try {\r\n    // Ensure the service worker is registered\r\n    const swReg = await navigator.serviceWorker.register(\"/firebase-messaging-sw.js\");\r\n    // Ask permission\r\n    const permission = await Notification.requestPermission();\r\n    if (permission !== \"granted\") {\r\n      console.warn(\"Notification permission not granted\");\r\n      return null;\r\n    }\r\n\r\n    // Get FCM token\r\n    const token = await getToken(messagingInstance, { vapidKey: VAPID_KEY, serviceWorkerRegistration: swReg });\r\n    if (!token) {\r\n      console.warn(\"No FCM token returned\");\r\n      return null;\r\n    }\r\n\r\n    // Save token to Firestore: either UserTokens/<uid> or update Donors/<uid>.fcmToken\r\n    await setDoc(doc(db, \"UserTokens\", uid), { token, updatedAt: new Date().toISOString() });\r\n\r\n    // Optional: also update Donors collection if that user is a donor record\r\n    await setDoc(doc(db, \"Donors\", uid), { fcmToken: token }, { merge: true });\r\n\r\n    console.log(\"FCM token saved for user\", uid);\r\n    return token;\r\n  } catch (err) {\r\n    console.error(\"registerTokenForUser error\", err);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function removeTokenForUser(uid) {\r\n  try {\r\n    await deleteDoc(doc(db, \"UserTokens\", uid));\r\n  } catch (_) {}\r\n\r\n  try {\r\n    await deleteToken(messaging);\r\n  } catch (_) {}\r\n}\r\n\r\n// Optional: in-app foreground callback\r\nexport function subscribeOnMessage(cb) {\r\n  if (!messagingInstance) initMessaging();\r\n  if (!messagingInstance) return;\r\n  onMessage(messagingInstance, (payload) => {\r\n    if (typeof cb === \"function\") cb(payload);\r\n  });\r\n}\r\n\r\n// Auto-register token when user signs in; remove on sign out.\r\n// Add this call once in your App entry (see next step)\r\nexport function setupAutoRegistration() {\r\n  onAuthStateChanged(auth, async (user) => {\r\n    if (user) {\r\n      // register token for signed-in user\r\n      await registerTokenForUser(user.uid);\r\n    } else {\r\n      // logged out: delete token from DB\r\n      // If you stored uid earlier, remove it. Here we can't access previous uid; ensure you remove on logout flow.\r\n    }\r\n  });\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}